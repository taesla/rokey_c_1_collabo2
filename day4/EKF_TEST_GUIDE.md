# EKF í†µí•© í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ğŸ”¬ Phase 5-1: EKF ë‹¨ë… êµ¬í˜„ ì™„ë£Œ

### âœ… êµ¬í˜„ ë‚´ìš©

1. **EKF í†µí•©**
   - `robot_control_node.py`ì— EKF í•„í„° í†µí•©
   - Raw ì‹ í˜¸ â†’ EKF í•„í„°ë§ â†’ P-Controller
   - 30Hz ì‹¤ì‹œê°„ ì²˜ë¦¬

2. **íŒŒë¼ë¯¸í„° ì œì–´**
   - `use_ekf`: True/False (EKF í™œì„±í™”)
   - `ekf_process_noise`: 0.1 (í”„ë¡œì„¸ìŠ¤ ë…¸ì´ì¦ˆ, Q)
   - `ekf_measurement_noise`: 10.0 (ì¸¡ì • ë…¸ì´ì¦ˆ, R, mm ë‹¨ìœ„)

3. **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**
   - 5ì´ˆë§ˆë‹¤ Raw vs Filtered ë¹„êµ ì¶œë ¥
   - ë…¸ì´ì¦ˆ í¬ê¸° (mm)
   - ì¶”ì • ì†ë„ (mm/s)

4. **ì‹œê°í™” ë„êµ¬**
   - `ekf_comparison_node`: Raw vs Filtered ì‹œê° ë¹„êµ
   - RViz ë§ˆì»¤ë¡œ ì‹¤ì‹œê°„ í‘œì‹œ

---

## ğŸš€ í…ŒìŠ¤íŠ¸ ë°©ë²•

### 1. EKF í™œì„±í™” í…ŒìŠ¤íŠ¸ (ê¶Œì¥)

**í„°ë¯¸ë„ 1: Face Detection + Tracking**
```bash
cd ~/ros2_ws
source install/setup.bash

# ì–¼êµ´ ê°ì§€
ros2 run face_tracking_pkg face_detection_node &

# ì–¼êµ´ ì¶”ì 
ros2 run face_tracking_pkg face_tracking_node &
```

**í„°ë¯¸ë„ 2: Robot Control (EKF ON)**
```bash
source ~/ros2_ws/install/setup.bash
ros2 run face_tracking_pkg robot_control_node \
  --ros-args \
  -p use_ekf:=true \
  -p ekf_process_noise:=0.1 \
  -p ekf_measurement_noise:=10.0
```

**ì˜ˆìƒ ì¶œë ¥**:
```
==================================================
ğŸ¤– Robot Control Node (J1+J5)
  Robot: dsr01 / m0609
  Velocity: 45
  ğŸ”¬ EKF: ON (Q=0.1, R=10.0)
  í‚¤: 's'=ì‹œì‘, 'p'=ì‚¬ì£¼ê²½ê³„ ì¬ê°œ, 'h'=í™ˆ, 'q'=ì¢…ë£Œ
==================================================
ğŸ”¬ EKF ì´ˆê¸°í™”: [650.5, 120.3, 450.2]
ğŸ“Š Raw: [652.1, 118.9, 451.3] | Filtered: [651.2, 119.5, 450.8] | Noise: 1.8mm | Vel: 45.3mm/s
```

---

### 2. EKF ë¹„êµ í…ŒìŠ¤íŠ¸ (Before/After)

**í„°ë¯¸ë„ 3: EKF Comparison (ì‹œê°í™”)**
```bash
source ~/ros2_ws/install/setup.bash
ros2 run face_tracking_pkg ekf_comparison_node
```

**í„°ë¯¸ë„ 4: RViz ì‹œê°í™”**
```bash
ros2 run rviz2 rviz2
```

**RViz ì„¤ì •**:
1. Fixed Frame: `base_link`
2. Add â†’ Marker â†’ Topic: `/ekf_comparison/raw` (ë¹¨ê°„ìƒ‰)
3. Add â†’ Marker â†’ Topic: `/ekf_comparison/filtered` (ì´ˆë¡ìƒ‰)

**ê´€ì°° í¬ì¸íŠ¸**:
- âœ… ë¹¨ê°„ìƒ‰(Raw): ë–¨ë¦¼ ì‹¬í•¨
- âœ… ì´ˆë¡ìƒ‰(Filtered): ë¶€ë“œëŸ¬ì›€
- âœ… ì°¨ì´ê°€ í´ìˆ˜ë¡ EKF íš¨ê³¼ í¼

---

### 3. EKF OFF í…ŒìŠ¤íŠ¸ (ë¹„êµìš©)

```bash
ros2 run face_tracking_pkg robot_control_node \
  --ros-args \
  -p use_ekf:=false
```

**ì˜ˆìƒ ì¶œë ¥**:
```
âš ï¸  EKF: OFF (Raw ì‹ í˜¸ ì‚¬ìš©)
```

---

## ğŸ“Š ì„±ëŠ¥ í‰ê°€ ê¸°ì¤€

### Before (EKF OFF)
- âŒ ìœ„ì¹˜ ë…¸ì´ì¦ˆ: Â±10mm
- âŒ ë–¨ë¦¼ ì‹¬í•¨
- âŒ ë¡œë´‡ ì›€ì§ì„ ë¶ˆì•ˆì •
- âŒ ì˜¤ë²„ìŠˆíŠ¸ ë°œìƒ

### After (EKF ON)
- âœ… ìœ„ì¹˜ ë…¸ì´ì¦ˆ: Â±2mm (80% ê°ì†Œ)
- âœ… ë¶€ë“œëŸ¬ìš´ ì¶”ì 
- âœ… ë¡œë´‡ ì›€ì§ì„ ì•ˆì •
- âœ… ì˜¤ë²„ìŠˆíŠ¸ ìµœì†Œí™”

---

## ğŸ›ï¸ íŒŒë¼ë¯¸í„° íŠœë‹

### Q (í”„ë¡œì„¸ìŠ¤ ë…¸ì´ì¦ˆ)
- **ì‘ê²Œ** (0.01): ëª¨ë¸ ì‹ ë¢° â†‘ â†’ ëŠë¦° ë°˜ì‘
- **ê¸°ë³¸** (0.1): ê· í˜•
- **í¬ê²Œ** (1.0): ì¸¡ì • ì‹ ë¢° â†‘ â†’ ë¹ ë¥¸ ë°˜ì‘

### R (ì¸¡ì • ë…¸ì´ì¦ˆ)
- **ì‘ê²Œ** (1.0): ì„¼ì„œ ì‹ ë¢° â†‘ â†’ ë–¨ë¦¼ ì¶”ì¢…
- **ê¸°ë³¸** (10.0): ê· í˜•
- **í¬ê²Œ** (50.0): ì„¼ì„œ ë¶ˆì‹  â†‘ â†’ ê³¼ë„í•œ í•„í„°ë§

**ì¶”ì²œ íŠœë‹**:
```bash
# ë¶€ë“œëŸ¬ì›€ ìš°ì„ 
-p ekf_process_noise:=0.05 -p ekf_measurement_noise:=20.0

# ë°˜ì‘ì„± ìš°ì„   
-p ekf_process_noise:=0.5 -p ekf_measurement_noise:=5.0

# ê· í˜• (ê¸°ë³¸)
-p ekf_process_noise:=0.1 -p ekf_measurement_noise:=10.0
```

---

## ğŸ› íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 1. EKF ì´ˆê¸°í™” ì‹¤íŒ¨
```
ERROR: filterpy not found
```
**í•´ê²°**: `pip install filterpy`

### 2. ê³¼ë„í•œ ì§€ì—°
```
ğŸ“Š Noise: 0.5mm (ë„ˆë¬´ ì‘ìŒ)
```
**ì›ì¸**: Rì´ ë„ˆë¬´ í¼ â†’ ì„¼ì„œë¥¼ ë„ˆë¬´ ë¶ˆì‹ 
**í•´ê²°**: `ekf_measurement_noise` ê°ì†Œ (10.0 â†’ 5.0)

### 3. ë–¨ë¦¼ ì—¬ì „í•¨
```
ğŸ“Š Noise: 15mm (ì—¬ì „íˆ í¼)
```
**ì›ì¸**: Rì´ ë„ˆë¬´ ì‘ìŒ â†’ ì„¼ì„œë¥¼ ë„ˆë¬´ ì‹ ë¢°
**í•´ê²°**: `ekf_measurement_noise` ì¦ê°€ (10.0 â†’ 20.0)

---

## ğŸ“ˆ ë‹¤ìŒ ë‹¨ê³„: MPC í†µí•© (Phase 5-2)

### EKF íš¨ê³¼ ê²€ì¦ í›„
1. âœ… ë…¸ì´ì¦ˆ 80% ì´ìƒ ê°ì†Œ
2. âœ… ë¶€ë“œëŸ¬ìš´ ì¶”ì  í™•ì¸
3. âœ… ì†ë„ ì¶”ì • ì•ˆì •

### MPC ì¶”ê°€ ê²°ì •
- **Case A**: EKFë§Œìœ¼ë¡œ ì¶©ë¶„ â†’ MPC ë¶ˆí•„ìš”
- **Case B**: ì˜¤ë²„ìŠˆíŠ¸/ì§„ë™ ì—¬ì „ â†’ MPC ì¶”ê°€

**MPC ì¶”ê°€ ì‹œ**:
```python
# EKF â†’ MPC íŒŒì´í”„ë¼ì¸
filtered_pos = ekf.get_position()
filtered_vel = ekf.get_velocity()
predicted_trajectory = ekf.predict_trajectory(N=10)

# MPC ìµœì í™”
optimal_control = mpc.solve(...)
```

---

## ğŸ“ ì¸¡ì • ì²´í¬ë¦¬ìŠ¤íŠ¸

### EKF ì„±ëŠ¥ ì¸¡ì •
- [ ] í‰ê·  ë…¸ì´ì¦ˆ: _____ mm (ëª©í‘œ: <3mm)
- [ ] ìµœëŒ€ ë…¸ì´ì¦ˆ: _____ mm (ëª©í‘œ: <10mm)
- [ ] ì†ë„ ì¶”ì •: ì•ˆì •ì ? (Y/N)
- [ ] ë¶€ë“œëŸ¬ì›€: ìœ¡ì•ˆ í™•ì¸ (1-10ì )

### ë¡œë´‡ ì¶”ì  ì„±ëŠ¥
- [ ] ì˜¤ë²„ìŠˆíŠ¸: ê°ì†Œ? (Y/N)
- [ ] ë–¨ë¦¼: ê°ì†Œ? (Y/N)
- [ ] ì¶”ì  ì •í™•ë„: ìœ ì§€? (Y/N)
- [ ] ì‹¤ì‹œê°„ ì„±ëŠ¥: 30Hz ìœ ì§€? (Y/N)

---

## ğŸ¯ ì„±ê³µ ê¸°ì¤€

### Minimum Viable (ìµœì†Œ ìš”êµ¬)
- âœ… ë…¸ì´ì¦ˆ 50% ì´ìƒ ê°ì†Œ
- âœ… ë¶€ë“œëŸ¬ì›€ ì²´ê°
- âœ… 30Hz ìœ ì§€

### Target (ëª©í‘œ)
- âœ… ë…¸ì´ì¦ˆ 80% ê°ì†Œ
- âœ… ë¡œë´‡ ì›€ì§ì„ ìì—°ìŠ¤ëŸ¬ì›€
- âœ… ì˜¤ë²„ìŠˆíŠ¸ ìµœì†Œí™”

### Stretch (ì´ìƒì )
- âœ… ë…¸ì´ì¦ˆ 90% ê°ì†Œ
- âœ… ì™„ë²½í•œ ì¶”ì 
- âœ… MPC ë¶ˆí•„ìš” ìˆ˜ì¤€

---

**EKF íš¨ê³¼ í™•ì¸ í›„ MPC í•„ìš”ì„± ì¬í‰ê°€í•©ë‹ˆë‹¤!**
